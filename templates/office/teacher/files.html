<hr class="my-4">
    <h1 class="text-center">Файли</h1>
<hr>
{% include 'office/teacher/add_file.html' %}
    <hr class="my-4">
    <div class="col-lg-12 col-sm-10 col-xs-3">
        <table class="table text-center table-bordered table-responsive-sm table-responsive-md table-hover table-info">
            <thead>
            <tr>
                <th scope="col">Група</th>
                <th scope="col">Предмет</th>
                <th scope="col">Файл</th>
                <th scope="col">Дії</th>
            </tr>
            </thead>
            <tbody>
            {% for file in files %}
                <tr id="href-{{ file.id }}">
                    <td>{{ file.subject.group.number }}</td>
                    <td>{{ file.subject.name }}</td>
                    <td><a href="{{ file.get_absolute_url }}" download>{{ file.title }}
                        [{{ file.file |make_list|slice:"-3:"|join:""|slugify }}]</a></td>
                    <td>
                        <button type="button"
                                data-id="{{ file.id }}"
                                data-title="{{ file.title }}"
                                data-path="{{ file.get_absolute_url }}"
                                data-subject-name="{{ file.subject.name }}"
                                data-group-number="{{ file.subject.group.number }}"
                                class="btn btn-success change-files"
                                data-toggle="modal"
                                data-target="#exampleModalLong">
                            <i class="far fa-edit"></i>
                        </button>
                        <button type="button"
                                data-id="{{ file.id }}"
                                data-title="{{ file.title }}"
                                data-path="{{ file.get_absolute_url }}"
                                class="btn btn-danger delete-files"
                                data-toggle="modal"
                                data-target="#delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>

            {% endfor %}
            </tbody>
        </table>
    </div>

    <!--  Start Edit Modal -->
    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="file-title">Вікно редагування даних</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="/api/teacher.files/" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">

                        <input type="hidden" name="id" value="" id="identificator">
                        <div class="form-group">
                            <p> Курс: <span id="subject-name"></span>, Група - <span id="group-number"></span></p>
                        </div>
                        <hr class="my-3">
                        <div class="form-group">
                            <label for="file-upload">Завантажено: <a href="" id="path-file"></a></label><br>
                            <input type="file" name="file" id="file-upload">
                        </div>
                        <hr class="my-4">

                        <div class="form-group">
                            <label for="title">Назва документа</label>
                            <input type="text" name="title" class="form-control" id="title"
                                   placeholder="Назва документа">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрити</button>
                        <button class="btn btn-success center-block" type="submit">Оновити дані</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End Edit Modal -->

    <!-- Start Delete Modal -->
    <div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="delete" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title " id="delete">Увага! Ви бажаєте видалити файл?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p><kbd id="del-file"></kbd> -> [<span id="del-path">[]</span>]</p>
                    <input type="hidden" id="del-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрити</button>
                    <button type="button" id="del-action" class="btn btn-danger">Видалити</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End Delete Modal -->

    <script type="text/javascript">
        $(document).ready(function () {
            // Fix trouble with csrf
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    function getCookie(name) {
                        var cookieValue = null;
                        if (document.cookie && document.cookie != '') {
                            var cookies = document.cookie.split(';');
                            for (var i = 0; i < cookies.length; i++) {
                                var cookie = jQuery.trim(cookies[i]);
                                // Does this cookie string begin with the name we want?
                                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                }
            });

            var TEACHER_FILES = '/api/teacher.files/';
            var $body = $("body");

            // Data into field
            $body.on('click', '.delete-files', function () {
                $("#del-file").text($(this).data('title'));
                $("#del-path").html("<a href='" + $(this).data('path') + "'>" + $(this).data('path') + "</a>")
                $("#del-id").val($(this).data('id'));
            });
            // Delete file
            $body.on("click", "#del-action", function (e) {
                e.preventDefault();

                // Delete files
                $.ajax({
                    type: 'GET',
                    url: TEACHER_FILES,
                    data: {
                        "id": $("#del-id").val(),
                    },
                    success: function () {
                        alert('Файл успішно видалено');
                        window.location.replace(location.href);
                    }
                });
            });

            // Change values in modal from button
            $body.on('click', '.change-files', function () {
                $("#title").val($(this).data('title'));
                $("#subject-name").text($(this).data('subject-name'));
                $("#group-number").text($(this).data('group-number'));
                $("#identificator").val($(this).data('id'));
                $("#path-file").attr("href", $(this).data('path'));
                $("#path-file").text($(this).data('path'));
            });

            try {
                $(location.href.match( /#href-.*/i )[0]).css({'background':'#eaeaea'});
            }catch (e) {}
        });
    </script>